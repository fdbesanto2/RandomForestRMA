---
title: "Data_setup"
author: "Rachel Schattman"
date: "February 19, 2019"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load libraries
```{r, echo=FALSE}
library(dplyr)
library(plyr)
library(randomForest)
library(Metrics)
library(rpart)
```

# Helpful resources:
## https://www.r-bloggers.com/how-to-implement-random-forests-in-r/
## https://cran.r-project.org/web/packages/randomForest/randomForest.pdf 
## https://rpubs.com/mbaumer/randomForest 


```{r}
script_path <- "C:/Users/rschattman/Documents/Research/RandomForestRMA/data"
in_dir <- "C:/Users/rschattman/Documents/Research/RandomForestRMA/data"
out_dir <- "C:/Users/rschattman/Documents/Research/RandomForestRMA/output/data"
```

# Read in data and combine into single dataframe
```{r}
PAcip <- read.csv(file = "C:/Users/rschattman/Documents/Research/RandomForestRMA/data/monthly_prcp_PA.csv", header = TRUE, sep = ",")
PAloss <- read.csv(file = "C:/Users/rschattman/Documents/Research/RandomForestRMA/data/PAannuallosses.csv", header = TRUE, sep = ",")
PAbeta <-merge(PAcip, PAloss)
```

# Create new data frames with one dependent variable
``` {r}
head(PAbeta)
WetAcres <- PAbeta[,c("Year", "month", "StateCollege_PRCP", "Lebanon_PRCP", "Selinsgrove_PRCP", "WetAcres")]
WetDollars <- PAbeta[,c("Year", "month", "StateCollege_PRCP", "Lebanon_PRCP", "Selinsgrove_PRCP", "WetDollars")]
DryDollars <- PAbeta[,c("Year", "month", "StateCollege_PRCP", "Lebanon_PRCP", "Selinsgrove_PRCP", "DryDollars")]
DryAcres <- PAbeta[,c("Year", "month", "StateCollege_PRCP", "Lebanon_PRCP", "Selinsgrove_PRCP", "DryAcres")]
```

# Review data
```{r}
head(WetAcres)
str(WetAcres)
summary(WetAcres)
```

# Split into trainning, validation, and test sets
```{r}
set.seed(25)
assignment <- sample(1:3, size = nrow(WetAcres), prob = c(0.7, 0.15, 0.15), replace = TRUE)

Wettrain <- WetAcres[assignment == 1,]
Wetvalid <- WetAcres[assignment == 2,]
Wettest <- WetAcres[assignment == 3,]

summary(Wettrain)
summary(Wetvalid)
summary(Wettest)
```

# Create Random Forest Model and test performance metrics
```{r}
Mod1 <- randomForest(WetAcres ~ ., 
                     data = Wettrain, 
                     ntree = 500, 
                     #method = "anova", 
                     importance = TRUE)


print(Mod1)
summary(Mod1)
plot(Mod1)

pred <- predict(object = Mod1, newdata = Wettest)
RMSE_Mod1 <- rmse(actual = Wettest$WetAcres, #actual values
     predicted = pred)                       #predicted values
print(RMSE_Mod1/mean(Wettest$WetAcres))      #tells us the %of the mean represented by RMSE. AKA "coefficient of variation"



# Tune mtry using OOB error
set.seed(25)
#train_pred <- predict(object = Mod1, newdata = PAtrain)
res <- tuneRF(x = Wettrain,
              y = Wettrain$WetAcre,
              ntree = 500,
              stepfactor = 0.5,
              doBest=FALSE)


```

# Fine tune model using control function
```{r}
Mod2 <- randomForest(WetAcres ~ ., 
                     data = Wettrain, 
                     ntree = 500, 
                     mtry = 6,                                        # based on tuneRF function results above
                     importance = TRUE,
                     control = rpart.control(minsplit = 20,           # default is 20
                                             cp = 0.01,               # default is 0.01
                                             maxdepth = 30))          # default is 30
print(Mod2)
summary(Mod2)
plot(Mod2)

pred <- predict(object = Mod2, newdata = Wettest)
RMSE_Mod2 <- rmse(actual = Wettest$WetAcres, #actual values
     predicted = pred)                       #predicted values
print(RMSE_Mod2/mean(Wettest$WetAcres))      #tells us the %of the mean represented by RMSE. AKA "coefficient of variation"

#start here in AM
#plotcp(Mod2)
#summary(rpart(Mod2))
```

# Predicting on train set and checking classification accuracy
```{r}
#predTrain <- predict(Mod2, PAtrain, type = "class")
#table(predTrain, PAtrain$DryAcres)  
```